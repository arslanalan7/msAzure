#In azure portal, open Azure Cloud Shell
#Create a resource group to contain all the resources for this exercise.
RGROUP=$(az group create --name vmbackups --location westus2 --output tsv --query name)

#create the NorthwindInternal virtual network and the NorthwindInternal1 subnet.
az network vnet create \
    --resource-group $RGROUP \
    --name NorthwindInternal \
    --address-prefixes 10.0.0.0/16 \
    --subnet-name NorthwindInternal1 \
    --subnet-prefixes 10.0.0.0/24

#Create a Windows virtual machine. Replace <password> with a password of your choice, enclosed in double quotes. For example, --admin-password "PassWord123!"
az vm create \
    --resource-group $RGROUP \
    --name NW-APP01 \
    --size Standard_DS1_v2 \
    --public-ip-sku Standard \
    --vnet-name NorthwindInternal \
    --subnet NorthwindInternal1 \
    --image Win2016Datacenter \
    --admin-username admin123 \
    --no-wait \
    --admin-password <password>

#Create a Linux virtual machine
az vm create \
    --resource-group $RGROUP \
    --name NW-RHEL01 \
    --size Standard_DS1_v2 \
    --image RedHat:RHEL:8-gen2:latest \
    --authentication-type ssh \
    --generate-ssh-keys \
    --vnet-name NorthwindInternal \
    --subnet NorthwindInternal1

#If you get a securityProfile.securityType is invalid error running the preceding command, run the following commands to register UseStandardSecurityType, then re-run the preceding command.
#az feature register --name UseStandardSecurityType --namespace Microsoft.Compute
#az feature show --name UseStandardSecurityType --namespace Microsoft.Compute

#Enable backup for a virtual machine by using the Azure portal
#1.In the Azure portal, search for and select Virtual machines.
#2.From the list, select the NW-RHEL01 virtual machine that you created.
#3.In the middle menu pane, select the Capabilities tab, then scroll down to and select Backup. The Backup pane for the NW-RHEL01 virtual machine appears.
#4.Select the radio button for Standard. You can accept the defaults for the following options:
    #Backup vault: vaultXXX for the name.
    #Backup policy: DailyPolicy-xxxxxxxx, which creates a daily backup at 12:00 PM UTC with a retention range of 180 days.
#6.Select the Enable backup button.
#7.Once deployment completes, go back to the NW-RHEL01 virtual machine, select the Capabilities tab, then scroll down to and select Backup. The Backup pane for the NW-RHEL01 virtual machine appears.
#To perform the first backup for this server, in the top menu bar, select Backup now.

#Enable a backup by using the Azure CLI
#1.First, create the azure-backup vault by using Cloud Shell:
az backup vault create \
    --resource-group vmbackups \
    --location westus2 \
    --name azure-backup

#2.Using Cloud Shell, enable a backup for the NW-APP01 virtual machine.
az backup protection enable-for-vm \
    --resource-group vmbackups \
    --vault-name azure-backup \
    --vm NW-APP01 \
    --policy-name EnhancedPolicy

#3.Monitor the progress of the setup using the Azure CLI.
az backup job list \
    --resource-group vmbackups \
    --vault-name azure-backup \
    --output table

#Keep running the preceding command until you see that ConfigureBackup is finished.
                      #Name                                  Operation        Status      Item Name    Start Time UTC                    Duration
                      #------------------------------------  ---------------  ----------  -----------  --------------------------------  --------------
                      #a3df79b4-be4f-4cc9-8b2c-a5ead44a6a12  ConfigureBackup  Completed   NW-APP01     2019-08-01T06:19:12.101048+00:00  0:00:31.305975
                      #5e1531a9-8b3d-4983-a642-86ee982f7036  Backup           InProgress  NW-RHEL01    2019-08-01T06:18:35.955118+00:00  0:01:22.734182
                      #860d4dca-9603-4a4e-9f3b-93f242a0a64d  ConfigureBackup  Completed   NW-RHEL01    2019-08-01T06:13:33.860598+00:00  0:00:31.256773    

#4.Do an initial backup of the virtual machine, instead of waiting for the schedule to run it.
az backup protection backup-now \
    --resource-group vmbackups \
    --vault-name azure-backup \
    --container-name NW-APP01 \
    --item-name NW-APP01 \
    --retain-until 18-10-2030 \
    --backup-management-type AzureIaasVM

#View the status of a backup for a single virtual machine
#in portal, go to VM. In the middle menu pane, select the Capabilities tab, then scroll to and select Backup. The Backup pane for the VM appears.
#Under the Backup status section, the Last backup status field displays the current status of the backup.
#View the status of backups in the Recovery Services vault
#On the Azure portal menu or from the Home page, select All resources. Sort the list by Type, and then select the azure-backup Recovery Services vault. The Azure-backup recovery services vault pane appears.
#On the Overview pane, select the interior Backup tab to display a summary of all the backup items, the storage being used, and the current status of any backup jobs.

*************************************Restore a disk and create a recovered VM in Azure******************************************************
#Kullanılabilir kurtarma noktalarını listeleme
az backup recoverypoint list \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --backup-management-type AzureIaasVM \
    --container-name myVM \
    --item-name myVM \
    --query [0].name \
    --output tsv

#Sanal makine diskini geri yükleme
#Yönetilen disk geri yükleme
#önce bir Azure depolama hesabı sağlarsınız. Bu depolama hesabı, vm yapılandırmasını ve daha sonra vm'yi geri yüklenen disklerden dağıtmak için kullanılabilecek dağıtım şablonunu depolamak için kullanılır. 
#Ardından, yönetilen disklerin geri yüklenmesi için bir hedef kaynak grubu da sağlarsınız.
az storage account create \
    --resource-group myResourceGroup \
    --name mystorageaccount \
    --sku Standard_LRS

#az backup restore restore-disks komutuyla kurtarma noktanızdan diski geri yükleyin.
#myRecoveryPointName değerini önceki az backup recoverypoint list komutundan elde ettiğiniz kurtarma noktası adıyla değiştirin. 
az backup restore restore-disks \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --storage-account mystorageaccount \
    --rp-name myRecoveryPointName \
    --target-resource-group targetRG

#***Uyarı

Target-resource-group sağlanmadıysa, yönetilen diskler belirli bir depolama hesabına yönetilmeyen diskler olarak geri yüklenir. Diskleri geri yüklemek için geçen süre tamamen verilen depolama hesabına
#bağlı olduğundan, bu durum geri yükleme süresinde önemli sonuçlar doğuracaktır. Anlık geri yükleme avantajını yalnızca target-resource-group parametresi verildiğinde elde edersiniz. 
#Amaç yönetilen diskleri yönetilmeyen olarak geri yüklemekse target-resource-group parametresini sağlamayın ve bunun yerine aşağıda gösterildiği gibi yönetilmeyen disk olarak geri yükleme parametresini sağlayın.
#Bu parametre, Azure CLI 3.4.0'dan itibaren kullanılabilir.
az backup restore restore-disks \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --storage-account mystorageaccount \
    --rp-name myRecoveryPointName \
    --restore-as-unmanaged-disk

#Diskleri ikincil bölgeye geri yükleme
az backup restore restore-disks \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --storage-account targetStorageAccountID \
    --rp-name myRecoveryPointName \
    --target-resource-group targetRG
    --use-secondary-region

#VM'i başka bir zpne'a geri yüklemek
az backup restore restore-disks \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --storage-account targetStorageAccountID \
    --rp-name myRecoveryPointName \
    --target-resource-group targetRG
    --target-zone 3

#Yönetilmeyen diskleri geri yükleme
az storage account create \
    --resource-group myResourceGroup \
    --name mystorageaccount \
    --sku Standard_LRS

az backup restore restore-disks \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --storage-account mystorageaccount \
    --rp-name myRecoveryPointName

#yönetilmeyen diskler özgün depolama hesaplarına geri yüklenir. Bu, en iyi geri yükleme performansını sağlar. Ancak tüm yönetilmeyen disklerin belirli bir depolama hesabına geri 
#yüklenmesi gerekiyorsa, aşağıda gösterildiği gibi ilgili bayrağı kullanın.
az backup restore restore-disks \
        --resource-group myResourceGroup \
        --vault-name myRecoveryServicesVault \
        --container-name myVM \
        --item-name myVM \
        --storage-account mystorageaccount \
        --rp-name myRecoveryPointName \
        --restore-to-staging-storage-account
    ```

## Monitor the restore job

To monitor the status of restore job, use [az backup job list](/cli/azure/backup/job#az-backup-job-list):

```azurecli-interactive
az backup job list \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --output table

#Geri yüklenen diskten sanal makine oluşturma
#Bu komutla job ID’leri bulabilir, 
az backup job list \
  --vault-name myRecoveryServicesVault \
  --resource-group myResourceGroup

#sonra -n parametresiyle detaylarını görebilirsin. 
az backup job show \
    -v myRecoveryServicesVault \
    -g myResourceGroup \
    -n 1fc2d55d-f0dc-4ca6-ad48-aca0fe5d0414

#Bu sorgunun çıktısı tüm ayrıntıları verir, ancak yalnızca depolama hesabı içeriğiyle ilgileniyoruz. İlgili ayrıntıları getirmek için Azure CLI'nın sorgu özelliğini kullanabiliriz
az backup job show \
    -v myRecoveryServicesVault \
    -g myResourceGroup \
    -n 1fc2d55d-f0dc-4ca6-ad48-aca0fe5d0414 \
    --query properties.extendedInfo.propertyBag

#İlk olarak, iş ayrıntılarından şablon blob Uri'sini ayıklayın
az backup job show \
    -v myRecoveryServicesVault \
    -g myResourceGroup \
    -n 1fc2d55d-f0dc-4ca6-ad48-aca0fe5d0414 \
    --query properties.extendedInfo.propertyBag."""Template Blob Uri"""

"https://mystorageaccount.blob.core.windows.net/myVM-daa1931199fd4a22ae601f46d8812276/azuredeploy1fc2d55d-f0dc-4ca6-ad48-aca0519c0232.json"

#Şimdi bu kapsayıcı ve şablon için SAS belirtecini burada ayrıntılı olarak bulabilirsiniz
expiretime=$(date -u -d '30 minutes' +%Y-%m-%dT%H:%MZ)
token=$(az storage blob generate-sas --account-name $storageAccountName --container-name $containerName --name $templateName --permissions r --expiry $expiretime --auth-mode login --as-user --https-only --output tsv)
url=$(az storage blob url --account-name $storageAccountName --container-name $containerName --name $templateName --output tsv --auth-mode login)

#VM oluşturmak için şablonu dağıtma
az deployment group create \
  --resource-group ExampleGroup \
  --template-uri $url?$token

#Kurtarılan diskinizden sanal makinenizin oluşturulduğunu onaylamak için az vm list komutuyla aşağıdaki şekilde kaynak grubunuzdaki sanal makineleri listeleyin:
az vm list --resource-group myResourceGroup --output table
