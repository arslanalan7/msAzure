#Deploy the network virtual appliance
az vm create \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --name nva \
    --vnet-name vnet \
    --subnet dmzsubnet \
    --image Ubuntu2204 \
    --admin-username azureuser \
    --admin-password <password>

#Enable IP forwarding for the Azure network interface
#you enable IP forwarding for the nva network appliance. When traffic flows to the NVA but is meant for another target, the NVA will route that traffic to its correct destination.

#1.Run the following command to get the NVA network interface's ID
NICID=$(az vm nic list \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --vm-name nva \
    --query "[].{id:id}" --output tsv)

echo $NICID

#2.Run the following command to get the NVA network interface's name:
NICNAME=$(az vm nic show \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --vm-name nva \
    --nic $NICID \
    --query "{name:name}" --output tsv)

echo $NICNAME

#3.Run the following command to enable IP forwarding for the network interface:
az network nic update --name $NICNAME \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --ip-forwarding true

#Enable IP forwarding in the appliance

#1. Run the following command to save the NVA virtual machine's public IP address to the variable NVAIP
NVAIP="$(az vm list-ip-addresses \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --name nva \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $NVAIP

#2.Run the following command to enable IP forwarding within the NVA
ssh -t -o StrictHostKeyChecking=no azureuser@$NVAIP 'sudo sysctl -w net.ipv4.ip_forward=1; exit;'

#Route traffic through the NVA

#deploy a VM into the public and private subnets.
#Open the Cloud Shell editor and create a file named cloud-init.txt.
code cloud-init.txt

#Add the following configuration information to the file. With this configuration, the inetutils-traceroute package is installed when you create a new VM. This package contains the traceroute utility that you'll use later in this exercise.
#cloud-config
package_upgrade: true
packages:
   - inetutils-traceroute

#In Cloud Shell, run the following command to create the public VM. Replace <password> with a suitable password for the azureuser account.
az vm create \
    --resource-group "learn-d67dac1d-4c26-4428-b030-99e28b6bd57b" \
    --name public \
    --vnet-name vnet \
    --subnet publicsubnet \
    --image Ubuntu2204 \
    --admin-username azureuser \
    --no-wait \
    --custom-data cloud-init.txt \
    --admin-password <password>
