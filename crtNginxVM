#Azure CLI commands

#Create a Linux virtual machine and install Nginx (PoverShell)

#Login to Azure
az login

#From Cloud Shell, run the following az vm create command to create a Linux VM
az vm create \
  --resource-group "[sandbox resource group name]" \
  --name my-vm \
  --public-ip-sku Standard \
  --image Ubuntu2204 \
  --admin-username azureuser \
  --generate-ssh-keys

#configure Nginx on your VM
az vm extension set \
  --resource-group "[sandbox resource group name]" \
  --vm-name my-vm \
  --name customScript \
  --publisher Microsoft.Azure.Extensions \
  --version 2.1 \
  --settings '{"fileUris":["https://raw.githubusercontent.com/MicrosoftDocs/mslearn-welcome-to-azure/master/configure-nginx.sh"]}' \
  --protected-settings '{"commandToExecute": "./configure-nginx.sh"}'

#Configure network rules to access web server

# First verify the VM you created previously is still running
az vm list

#Run the following "az vm list-ip-addresses" command to get your VM's IP address and store the result as a Bash variable
$IPADDRESS="$(az vm list-ip-addresses \
  --resource-group "[sandbox resource group name]" \
  --name my-vm \
  --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
  --output tsv)"

#Run the following curl command to download the home page (testing)
#we can't access to web server. We receiver curl: (28) Connection timed out after 5001 milliseconds error messages
curl --connect-timeout 5 http://$IPADDRESS 

#We can see the IP address. We can test this IP address on web browser
echo $IPADDRESS

#Run the following "az network nsg list" command to list the network security groups that are associated with your VM
#We'll see NSG group name for example: my-vmNSG
az network nsg list \
  --resource-group "[sandbox resource group name]" \
  --query '[].name' \
  --output tsv

#Run the following "az network nsg rule list" command to list the rules associated with the NSG named my-vmNSG:
az network nsg rule list \
  --resource-group "[sandbox resource group name]" \
  --nsg-name my-vmNSG \
  --query '[].{Name:name, Priority:priority, Port:destinationPortRange, Access:access}' \
  --output table

#You will see 

Name              Priority    Port    Access
-----------------  ----------  ------  --------
default-allow-ssh  1000        22      Allow

#Run the following "az network nsg rule create" command to create a rule called allow-http that allows inbound access on port 80:
az network nsg rule create \
  --resource-group "[sandbox resource group name]" \
  --nsg-name my-vmNSG \
  --name allow-http \
  --protocol tcp \
  --priority 100 \
  --destination-port-range 80 \
  --access Allow

#Then, when we check we will see
Name              Priority    Port    Access
-----------------  ----------  ------  --------
default-allow-ssh  1000        22      Allow
allow-http          100        80      Allow

#Now, we can access web server
